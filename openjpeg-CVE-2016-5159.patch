From d7b8ac0dbbcf07de6ef9a5fa14bc1034f79b16a1 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Nikola=20Forr=C3=B3?= <nforro@redhat.com>
Date: Tue, 21 Feb 2017 09:56:06 +0100
Subject: [PATCH 3/4] Fix CVE-2016-5159

---
 libopenjpeg/tcd.c | 18 +++++++++++++++++-
 1 file changed, 17 insertions(+), 1 deletion(-)

diff --git a/libopenjpeg/tcd.c b/libopenjpeg/tcd.c
index f68a5d4..4aa0bb8 100755
--- a/libopenjpeg/tcd.c
+++ b/libopenjpeg/tcd.c
@@ -820,11 +820,27 @@ void tcd_malloc_decode_tile(opj_tcd_t *tcd, opj_image_t * image, opj_cp_t * cp,
 					prc->cw = (brcblkxend - tlcblkxstart) >> cblkwidthexpn;
 					prc->ch = (brcblkyend - tlcblkystart) >> cblkheightexpn;
 
+					if (prc->cw && ((uint32_t)-1) / prc->cw < prc->ch) {
+						cp->tileno[tileno] = -1;
+						return;
+					}
+
+					if (((uint32_t)-1) / (uint32_t)sizeof(opj_tcd_cblk_dec_t) < prc->cw * prc->ch) {
+						cp->tileno[tileno] = -1;
+						return;
+					}
+
 					prc->cblks.dec = (opj_tcd_cblk_dec_t*) opj_malloc(prc->cw * prc->ch * sizeof(opj_tcd_cblk_dec_t));
 
+					if (prc->cblks.dec == NULL) {
+						opj_event_msg(tcd->cinfo, EVT_ERROR, "Not enough memory for current precinct codeblock element\n");
+						cp->tileno[tileno] = -1;
+						return;
+					}
+
 					prc->incltree = tgt_create(prc->cw, prc->ch);
 					prc->imsbtree = tgt_create(prc->cw, prc->ch);
-					
+
 					for (cblkno = 0; cblkno < prc->cw * prc->ch; cblkno++) {
 						int cblkxstart = tlcblkxstart + (cblkno % prc->cw) * (1 << cblkwidthexpn);
 						int cblkystart = tlcblkystart + (cblkno / prc->cw) * (1 << cblkheightexpn);
-- 
2.7.4

